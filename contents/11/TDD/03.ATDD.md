# ATDD

인수 테스트를 먼저 작성한 다음 기능 개발을 하는 개발방법론

![Result](https://github.com/jihunparkme/blog/blob/main/img/11-seminar/atdd.png?raw=true 'Result')

## Example

### Step01. 인수 테스트 작성

**Create Failing Integration Test**

- Controller 가 아직 구현되지 않았으므로 Acceptance Test 실패 (404)

```java
@SpringBootTest
@AutoConfigureMockMvc
public class OrderApiIntegrationTest {
    @Autowired
    private MockMvc mockMvc;
    @Autowired
    private ObjectMapper objectMapper;

    @Test
    public void createPendingOrderTest() throws Exception {
        //given
        Long productId = 1L;
        int quantity = 2;
        PendingOrderRequest request = PendingOrderRequest.of(productId, quantity);

        //when (Step 02.)
        MockHttpServletResponse response = mockMvc.perform(post("/orders/pendingOrder")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andReturn().getResponse();

        //then (Step 01.)
        assertThat(response.getStatus()).isEqualTo(HttpStatus.OK.value());
        PendingOrderResponse pendingOrderResponse = objectMapper.readValue(response.getContentAsString(), PendingOrderResponse.class);
        assertThat(pendingOrderResponse.getId()).isGreaterThan(0);
    }
}
```

### Step02. Controller 작성

- Acceptance Test는 이제 올바른 이유로 실패
- Controller 는 Service 가 필요
- Double Loop of TDD
  - 처음에는 Acceptance Test(Outer Loop)로 시작
  - Acceptance Test가 올바른 이유로 실패하면 TDD의 Inner Loop(Unit Test)로 들어감
  - Unit Test가 모두 성공하면 이 Acceptance Test도 성공할 것을 기대

```java
@RestController
public class OrderApiController {
    @PostMapping("/orders/pendingOrder")
    public ResponseEntity<PendingOrderResponse> createPendingOrder(@RequestBody PendingOrderRequest request) {
        PendingOrderResponse response = new PendingOrderResponse(request.getProductId(), request.getQuantity());
        return ResponseEntity.ok(response);
    }
}
```

### Step03. Service 테스트 작성

- Test 가 성공하면 CreateOrderServiceImpl, PendingOrderRepositoryMemoryImpl 는 main package 로 이동시켜주기

```java
class CreateOrderServiceTest {
    private CreateOrderService createOrderService = new CreateOrderServiceImpl();

    @Test
    void createPendingOrder() {
        // Given
        long productId = 1L;
        int quantity = 2;
        PendingOrderRequest request = new PendingOrderRequest(productId, quantity);

        // When
        PendingOrder pendingOrder = createOrderService.createPendingOrder(request);

        // Then (Step 01.)
        assertThat(pendingOrder.getId()).isPositive();
    }

    /**
     * inner class 에 static 을 추가해서 GC가 안되는 문제를 해결
     */
    private static class CreateOrderServiceImpl implements CreateOrderService {
        private final PendingOrderRepository pendingOrderRepository = new PendingOrderRepositoryMemoryImpl();

        @Override
        public PendingOrder createPendingOrder(PendingOrderRequest request) {
             PendingOrder pendingOrder = PendingOrder.create(request.getProductId(), request.getQuantity());
            return pendingOrderRepository.save(pendingOrder);
        }
    }

    private static class PendingOrderRepositoryMemoryImpl implements PendingOrderRepository {
        private final AtomicLong atomicId = new AtomicLong(1);

        @Override
        public PendingOrder save(PendingOrder pendingOrder) {
            pendingOrder.assignId(nextId());
            return pendingOrder;
        }

        private long nextId() {
            return atomicId.getAndIncrement();
        }
    }
}
```

> [project](https://github.com/jihunparkme/blog/tree/main/contents/11/TDD/project)